#!/usr/bin/env sh
# Builds and runs commands in the docker container:
#
# Obtain an interactive session:
# ./ci/run_docker it
#
# Build and run the benchmarks
# ./ci/run_docker ...options (see ./ci/run)...
set -e

IMG=barneshut:latest

# Build container
hpccm --recipe=ci/recipe.py | docker build -t $IMG -

GPUS=""
if command nvidia-smi ; then
    export GPU="nv"
    GPUS="--gpus=all"
fi
if command rocm-smi ; then
    export GPU="amd"
    GPUS="--device=/dev/kfd --device=/dev/dri/renderD128 --shm-size 16G --group-add 109"
fi
 
DOCKER_CMDS="\
       -it \
       -u $(id -u):$(id -g) \
       -h $(hostname) \
       -v $(pwd):/src \
       -w /src \
       ${GPUS} \
       --privileged \
       --network=host \
       --cap-add=SYS_PTRACE \
       --security-opt seccomp=unconfined \
       -e RUN_ONLY:"${RUN_ONLY}" \
       -e BUILD_ONLY:"${BUILD_ONLY}" \
       -e GPU:"${GPU}" \
       $IMG \
"

case $1 in
    it)
        # Run container interactively:
        docker run $DOCKER_CMDS
        ;;
    fmt)
        # Format the code using the container's clang-format:
        docker run $DOCKER_CMDS bash -c "set -ex && ./ci/fmt"
        ;;
    bench_detail)
        # Format the code using the container's clang-format:
        docker run $DOCKER_CMDS bash -c "set -ex && ./ci/benchmark_detailed 2>&1 | tee out_$(hostname)"
        ;;
    bench)
        # Format the code using the container's clang-format:
        docker run $DOCKER_CMDS bash -c "set -ex && ./ci/benchmark 2>&1 | tee out_$(hostname)"
        ;;
    *)
        # Run container:
        docker run $DOCKER_CMDS \
            bash -c "set -ex && \
                       GPU=${GPU} \
                       RUN_ONLY=$RUN_ONLY \
                       BUILD_ONLY=$BUILD_ONLY \
                       ./ci/run $1 $2 $3 $4 $5 $6 $7 $8 $9"
        ;;
esac
